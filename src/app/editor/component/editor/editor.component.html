<ng-container *ngIf="currentStep$ | async as currentStep">
  <form [formGroup]="form">
    <div class="editor-container">
      <div
        class="title"
        [class.font-white]="
          (currentStep === step.Background || currentStep === step.Preview) &&
          bgColor !== 'white'
        "
      >
        <div
          class="info-icon"
          (click)="recommendMusic()"
          *ngIf="currentStep === step.Music"
        ></div>
        <h1 class="font-h1-kr">{{ title[currentStep].kr }}</h1>
        <h1 class="font-h1">{{ title[currentStep].en }}</h1>
      </div>

      <div *ngIf="cardShape" class="preview-container" (click)="onToggleFlip()">
        <div
          class="flip-card selected-motion"
          [class.flipped]="currentStep === step.Text"
          [class.active-preview]="isActiveFlip"
          [ngClass]="cardShape.type"
        >
          <div class="flip-card-inner">
            <div class="flip-card-front">
              <div class="preview">
                <card-object
                  [cardType]="cardShape.type"
                  [lettering]="cardShape.lettering"
                ></card-object>
              </div>
            </div>
            <div class="flip-card-back">
              <div class="preview">
                <card-object
                  [cardType]="cardShape.type"
                  [lettering]="'flipped'"
                ></card-object>
                <div *ngIf="currentStep === step.Text" class="text-editor">
                  <div class="flexbox input-to">
                    <span class="font-sub">to.</span
                    ><input
                      type="text"
                      formControlName="receiver"
                      maxlength="25"
                    />
                  </div>
                  <div class="letter-textbox">
                    <textarea type="textbox" formControlName="text"> </textarea>
                    <div class="text-length-inform">
                      {{ currentLetterLength }} / {{ letterMaxLength }}
                    </div>
                  </div>
                  <div class="flexbox input-from">
                    <span class="font-sub">from.</span
                    ><input
                      type="text"
                      formControlName="sender"
                      maxlength="25"
                    />
                  </div>
                </div>
                <!-- @TODO: 프리뷰 버전 편지 적용하기 (뒤집힌 카드에) -->
                <div *ngIf="currentStep === step.Preview" class="text-preview">
                  <div class="input-to">
                    <span class="font-sub">to. </span
                    ><span class="font-card">{{ cardContent.receiver }}</span>
                  </div>

                  <p
                    [innerHtml]="cardContent.text | newlineToBr"
                    class="font-card"
                  ></p>
                  <div class="input-from">
                    <span class="font-sub">from. </span
                    ><span class="font-card">{{ cardContent.sender }}</span>
                  </div>

                  <div class="inform-music" *ngIf="selectedMusic">
                    {{ selectedMusic.name }} - {{ selectedMusic.artist }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="editor-controls">
        <ng-container [ngSwitch]="currentStep">
          <ng-container *ngSwitchCase="step.Card">
            <form-card-shape controlName="shape"></form-card-shape>
          </ng-container>
          <ng-container *ngSwitchCase="step.Lettering">
            <form-lettering controlName="lettering"></form-lettering>
          </ng-container>
          <ng-container *ngSwitchCase="step.Background">
            <form-card-bg></form-card-bg>
          </ng-container>
          <ng-container *ngSwitchCase="step.Music">
            <form-music-playlist controlName="musicId"></form-music-playlist>
          </ng-container>
          <ng-container *ngSwitchCase="step.Text"> </ng-container>
          <ng-container *ngSwitchCase="step.Preview"> </ng-container>
        </ng-container>
      </div>

      <div class="button-container">
        <button class="button-default" (click)="onClickPrev()">
          {{ currentStep === step.Card ? "첫 화면으로" : "이전 단계" }}
        </button>
        <button
          *ngIf="currentStep !== step.Preview; else preview"
          class="button-highlight"
          (click)="onClickNext()"
        >
          {{ currentStep === step.Text ? "완성된 카드 확인" : "다음 단계" }}
        </button>

        <ng-template #preview>
          <button class="button-highlight" (click)="onSave()">
            {{ "친구에게 보내기" }}
          </button>
        </ng-template>
      </div>
    </div>
  </form>

  <bg-canvas
    *ngIf="currentStep === step.Background || currentStep === step.Preview"
    [color]="bgColor"
    [effect]="bgEffect"
  ></bg-canvas>

  <ng-container *ngIf="currentStep === step.Preview && isActiveFlip">
    <div *ngIf="musicId" class="player-ui">
      <div (click)="onToggleFlip()"></div>
    </div>
    <div id="player" class="playing-motion">
      <app-youtube-player
        *ngIf="musicId"
        [musicId]="musicId"
      ></app-youtube-player>
    </div>
  </ng-container>
</ng-container>
